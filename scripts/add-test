#!/bin/bash

# mac-clip add-test script
# Generates a test file for a model or service

set -e

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
TESTS_DIR="$PROJECT_DIR/MacClipTests"

if [ -z "$1" ]; then
    echo "Usage: add-test <ModelOrServiceName>"
    echo "Example: add-test MyModel"
    exit 1
fi

TARGET_NAME="$1"
TEST_FILE="$TESTS_DIR/${TARGET_NAME}Tests.swift"

# Check if test already exists
if [ -f "$TEST_FILE" ]; then
    echo "âŒ Test file already exists at $TEST_FILE"
    exit 1
fi

# Try to determine if it's a service or model
if grep -q "final class $TARGET_NAME" "$PROJECT_DIR/MacClip/Services/"*.swift 2>/dev/null; then
    TEST_TYPE="service"
    echo "ðŸ“ Creating test for Service: $TARGET_NAME"
elif grep -q "struct $TARGET_NAME\|final class $TARGET_NAME" "$PROJECT_DIR/MacClip/Models/"*.swift 2>/dev/null; then
    TEST_TYPE="model"
    echo "ðŸ“ Creating test for Model: $TARGET_NAME"
else
    echo "âš ï¸  Could not determine if $TARGET_NAME is a service or model"
    read -p "Create as (s)ervice or (m)odel test? " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]; then
        TEST_TYPE="service"
    else
        TEST_TYPE="model"
    fi
fi

# Create appropriate test template
if [ "$TEST_TYPE" = "service" ]; then
    cat > "$TEST_FILE" << 'EOF'
import XCTest
@testable import MacClip

final class TARGET_NAME_PLACEHOLDERTests: XCTestCase {
    var sut: TARGET_NAME_PLACEHOLDER!
    var mockHistory: ClipboardHistory!

    override func setUp() {
        super.setUp()
        mockHistory = ClipboardHistory()
        sut = TARGET_NAME_PLACEHOLDER(history: mockHistory)
    }

    override func tearDown() {
        sut.stop()
        sut = nil
        mockHistory = nil
        super.tearDown()
    }

    func testInitialization() {
        XCTAssertNotNil(sut)
    }

    func testStart() {
        sut.start()
        // TODO: Assert expected behavior
    }

    func testStop() {
        sut.start()
        sut.stop()
        // TODO: Assert cleanup behavior
    }
}
EOF
else
    # Model test template
    cat > "$TEST_FILE" << 'EOF'
import XCTest
@testable import MacClip

final class TARGET_NAME_PLACEHOLDERTests: XCTestCase {
    var sut: TARGET_NAME_PLACEHOLDER!

    override func setUp() {
        super.setUp()
        // TODO: Initialize your model
        sut = TARGET_NAME_PLACEHOLDER()
    }

    override func tearDown() {
        sut = nil
        super.tearDown()
    }

    func testInitialization() {
        XCTAssertNotNil(sut)
    }

    func testEquality() {
        // TODO: Test model equality
    }

    func testIdentity() {
        // TODO: Test Identifiable conformance if applicable
    }
}
EOF
fi

# Replace placeholder
sed -i '' "s/TARGET_NAME_PLACEHOLDER/$TARGET_NAME/g" "$TEST_FILE"

echo "âœ… Created $TEST_FILE"
echo ""
echo "ðŸ“‹ Next steps:"
echo "   1. Update the test file with actual test cases"
echo "   2. Run tests with: ./scripts/test"
